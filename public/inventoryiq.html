<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InventoryIQ - BoutiqueFlow</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; line-height: 1.6; }
    .header { background: white; border-bottom: 1px solid #e0e0e0; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; }
    .logo { font-size: 1.5rem; font-weight: 700; color: #222; text-decoration: none; }
    .logo span { color: #e91e8a; }
    .nav-links { display: flex; align-items: center; gap: 24px; }
    .nav-links a { display: flex; align-items: center; gap: 8px; text-decoration: none; color: #222; font-weight: 500; font-size: 0.9rem; }
    .pro-badge-small { background: linear-gradient(135deg, #e91e8a 0%, #ff6b9d 100%); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.65rem; font-weight: 600; }
    .container { max-width: 1400px; margin: 0 auto; padding: 32px 20px; }
    .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
    .page-title-row { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
    .page-title { font-size: 1.5rem; margin: 0; color: #222; }
    .pro-badge { background: linear-gradient(135deg, #e91e8a 0%, #ff6b9d 100%); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
    .page-subtitle { color: #666; margin: 0; }
    .header-actions { display: flex; align-items: center; gap: 12px; }
    .sync-btn { padding: 10px 20px; background: #e91e8a; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
    .sync-btn:hover { background: #d1177b; }
    .sync-btn:disabled { background: #ccc; cursor: not-allowed; }
    .sync-status { font-size: 0.8rem; color: #666; }
    .sync-status.success { color: #059669; }

    .store-health { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); border-radius: 16px; padding: 24px; margin-bottom: 24px; color: white; }
    .store-health-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; }
    .health-metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .health-metric { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; text-align: center; }
    .health-metric-label { font-size: 0.75rem; opacity: 0.8; margin-bottom: 4px; }
    .health-metric-value { font-size: 1.5rem; font-weight: 700; }
    .health-metric-sub { font-size: 0.75rem; opacity: 0.7; margin-top: 4px; }
    .health-metric.good .health-metric-value { color: #4ade80; }
    .health-metric.warning .health-metric-value { color: #fbbf24; }
    .health-metric.danger .health-metric-value { color: #f87171; }

    .velocity-section { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
    .velocity-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .velocity-title { font-size: 1rem; font-weight: 600; color: #222; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .info-btn { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; border-radius: 50%; background: #e0e0e0; color: #666; font-size: 0.7rem; font-weight: 700; cursor: help; border: none; position: relative; }
    .info-btn:hover { background: #d0d0d0; }
    .tooltip { display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 400; width: 220px; text-align: left; line-height: 1.4; z-index: 100; margin-bottom: 6px; }
    .tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: #333; }
    .info-btn:hover .tooltip { display: block; }
    .velocity-list { display: flex; flex-direction: column; gap: 12px; }
    .velocity-item { display: flex; align-items: center; gap: 12px; }
    .velocity-rank { width: 24px; height: 24px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: #666; }
    .velocity-rank.fast { background: #d1fae5; color: #059669; }
    .velocity-rank.slow { background: #fee2e2; color: #dc2626; }
    .velocity-info { flex: 1; }
    .velocity-name { font-weight: 500; color: #222; font-size: 0.9rem; }
    .velocity-meta { font-size: 0.75rem; color: #888; }
    .velocity-days { font-weight: 600; font-size: 0.9rem; color: #222; }
    .velocity-days.fast { color: #059669; }
    .velocity-days.slow { color: #dc2626; }

    .section-title { font-size: 1.1rem; font-weight: 600; color: #222; margin-bottom: 16px; }
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
    .stat-card.active { border-color: #e91e8a; }
    .stat-card.watch { border-left: 4px solid #facc15; }
    .stat-card.slow { border-left: 4px solid #f59e0b; }
    .stat-card.dead { border-left: 4px solid #ef4444; }
    .stat-card.emergency { border-left: 4px solid #7f1d1d; }
    .stat-number { font-size: 1.75rem; font-weight: 700; color: #222; margin-bottom: 4px; }
    .stat-label { font-size: 0.85rem; color: #666; }
    .stat-value { font-size: 0.9rem; font-weight: 600; color: #e91e8a; margin-top: 8px; }

    .filter-row { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .filter-pill { padding: 8px 16px; border-radius: 20px; border: 1px solid #ddd; background: white; font-size: 0.85rem; cursor: pointer; }
    .filter-pill:hover { border-color: #e91e8a; }
    .filter-pill.active { background: #e91e8a; color: white; border-color: #e91e8a; }

    .data-table { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
    .table-header { display: grid; grid-template-columns: 2fr 1fr 1fr 0.7fr 0.7fr 0.7fr 0.8fr 1.2fr; gap: 12px; padding: 14px 20px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; font-size: 0.75rem; font-weight: 600; color: #666; text-transform: uppercase; }
    .table-row { display: grid; grid-template-columns: 2fr 1fr 1fr 0.7fr 0.7fr 0.7fr 0.8fr 1.2fr; gap: 12px; padding: 14px 20px; border-bottom: 1px solid #f0f0f0; align-items: center; font-size: 0.9rem; }
    .table-row:hover { background: #fafafa; }
    .item-name { font-weight: 500; color: #222; }
    .item-meta { color: #666; font-size: 0.85rem; }
    .days-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
    .days-badge.watch { background: #fef9c3; color: #854d0e; }
    .days-badge.slow { background: #ffedd5; color: #9a3412; }
    .days-badge.dead { background: #fee2e2; color: #991b1b; }
    .days-badge.emergency { background: #7f1d1d; color: white; }
    .suggested-action { font-size: 0.8rem; color: #dc2626; font-weight: 500; }

    .loading { text-align: center; padding: 40px; color: #888; }
    .spinner { width: 24px; height: 24px; border: 3px solid #f0f0f0; border-top-color: #e91e8a; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty-state { text-align: center; padding: 60px 20px; }
    .empty-state .icon { font-size: 3rem; margin-bottom: 16px; }
    .empty-state h3 { font-size: 1.25rem; margin-bottom: 8px; }
    .empty-state p { color: #888; }

    @media (max-width: 900px) {
      .health-metrics, .stats-row { grid-template-columns: repeat(2, 1fr); }
      .velocity-section { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="index.html" class="logo">Boutique<span>Flow</span></a>
    <nav class="nav-links">
      <a href="index.html">ReceiptAI</a>
      <a href="inventoryiq.html"><strong>InventoryIQ</strong> <span class="pro-badge-small">PRO</span></a>
      <a href="salesiq.html">SalesIQ <span class="pro-badge-small">PRO</span></a>
      <a href="first-dibs.html">First Dibs <span class="pro-badge-small">PRO</span></a>
      <a href="retargeting.html">Retargeting <span class="pro-badge-small">PRO</span></a>
    </nav>
  </div>

  <div class="container">
    <div class="page-header">
      <div>
        <div class="page-title-row">
          <h1 class="page-title">InventoryIQ</h1>
          <span class="pro-badge">PRO</span>
        </div>
        <p class="page-subtitle">X-ray vision into trapped capital ‚Äî Days since received</p>
      </div>
      <div class="header-actions">
        <span class="sync-status" id="syncStatus">Loading...</span>
        <button class="sync-btn" id="syncBtn" onclick="runSync()">üîÑ Sync Data</button>
      </div>
    </div>

    <div class="store-health">
      <div class="store-health-title">üìä Inventory Health (at cost) ‚Äî Goal: Under 20% on hand after 60 days</div>
      <div class="health-metrics">
        <div class="health-metric" id="health30">
          <div class="health-metric-label">Received Last 30 Days</div>
          <div class="health-metric-value" id="pct30">--%</div>
          <div class="health-metric-sub" id="val30">cost still on hand</div>
        </div>
        <div class="health-metric" id="health45">
          <div class="health-metric-label">Received Last 45 Days</div>
          <div class="health-metric-value" id="pct45">--%</div>
          <div class="health-metric-sub" id="val45">cost still on hand</div>
        </div>
        <div class="health-metric" id="health60">
          <div class="health-metric-label">Received Last 60 Days</div>
          <div class="health-metric-value" id="pct60">--%</div>
          <div class="health-metric-sub" id="val60">cost still on hand</div>
        </div>
        <div class="health-metric" id="health90">
          <div class="health-metric-label">Received Last 90 Days</div>
          <div class="health-metric-value" id="pct90">--%</div>
          <div class="health-metric-sub" id="val90">cost still on hand</div>
        </div>
      </div>
    </div>

    <div class="velocity-section">
      <div class="velocity-card">
        <div class="velocity-title">
          <span>üì¶</span> Sell-Through by Category
          <button class="info-btn">‚ìò<span class="tooltip">Average days from when you receive items in this category to when they sell. Lower = faster selling. Helps identify which product types move quickest.</span></button>
        </div>
        <div class="velocity-list" id="categoryVelocity"><div class="loading">Loading...</div></div>
      </div>
      <div class="velocity-card">
        <div class="velocity-title">
          <span>üè∑Ô∏è</span> Sell-Through by Vendor
          <button class="info-btn">‚ìò<span class="tooltip">Average days from receipt to sale by vendor. Shows which vendors' products sell fastest. Use this to guide future buying decisions.</span></button>
        </div>
        <div class="velocity-list" id="vendorVelocity"><div class="loading">Loading...</div></div>
      </div>
    </div>

    <h2 class="section-title">‚è∞ Aging Inventory ‚Äî Days Since Received</h2>

    <div class="stats-row">
      <div class="stat-card watch" onclick="filterByBucket('watch')" id="cardWatch">
        <div class="stat-number" id="countWatch">-</div>
        <div class="stat-label">Watch (45-59 Days)</div>
        <div class="stat-value" id="valueWatch">$0 at cost</div>
      </div>
      <div class="stat-card slow" onclick="filterByBucket('slow')" id="cardSlow">
        <div class="stat-number" id="count60">-</div>
        <div class="stat-label">Slow (60-89 Days)</div>
        <div class="stat-value" id="value60">$0 at cost</div>
      </div>
      <div class="stat-card dead" onclick="filterByBucket('dead')" id="cardDead">
        <div class="stat-number" id="count90">-</div>
        <div class="stat-label">Dead (90-119 Days)</div>
        <div class="stat-value" id="value90">$0 at cost</div>
      </div>
      <div class="stat-card emergency" onclick="filterByBucket('emergency')" id="cardEmergency">
        <div class="stat-number" id="count120">-</div>
        <div class="stat-label">Emergency (120+ Days)</div>
        <div class="stat-value" id="value120">$0 at cost</div>
      </div>
    </div>

    <div class="filter-row">
      <button class="filter-pill active" onclick="filterByBucket('all')" id="filterAll">All Aging Stock</button>
      <button class="filter-pill" onclick="filterByBucket('watch')" id="filterWatch">Watch (45-59)</button>
      <button class="filter-pill" onclick="filterByBucket('slow')" id="filterSlow">Slow (60-89)</button>
      <button class="filter-pill" onclick="filterByBucket('dead')" id="filterDead">Dead (90-119)</button>
      <button class="filter-pill" onclick="filterByBucket('emergency')" id="filterEmergency">Emergency (120+)</button>
    </div>

    <div class="data-table">
      <div class="table-header">
        <div>Item</div><div>Vendor</div><div>Category</div><div>Recv'd</div><div>Sold</div><div>Left</div><div>Days</div><div>Action</div>
      </div>
      <div id="tableBody">
        <div class="loading"><div class="spinner"></div><p>Loading inventory data...</p></div>
      </div>
    </div>
  </div>

  <script>
    let inventoryData = null;
    let currentFilter = 'all';

    async function loadData() {
      try {
        const response = await fetch('/api/inventory/data');
        const data = await response.json();
        if (data.error === 'No data yet') { showNoData(); return; }
        inventoryData = data;
        if (data.syncedAt) {
          const syncDate = new Date(data.syncedAt);
          document.getElementById('syncStatus').textContent = 'Last synced: ' + syncDate.toLocaleDateString() + ' ' + syncDate.toLocaleTimeString();
          document.getElementById('syncStatus').classList.add('success');
        }
        renderStoreHealth();
        renderVelocity();
        renderDeadStock();
      } catch (error) {
        console.error('Error loading data:', error);
        showError(error.message);
      }
    }

    function showNoData() {
      document.getElementById('tableBody').innerHTML = '<div class="empty-state"><div class="icon">üìä</div><h3>No inventory data yet</h3><p>Click "Sync Data" to analyze your inventory. First sync may take 2-3 minutes.</p></div>';
    }

    function showError(message) {
      document.getElementById('tableBody').innerHTML = '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><h3>Error loading data</h3><p>' + message + '</p></div>';
    }

    function renderStoreHealth() {
      const metrics = inventoryData?.deadStock?.storeMetrics;
      if (!metrics) return;
      document.getElementById('pct30').textContent = metrics.pctOnHand30Days + '%';
      document.getElementById('val30').textContent = '$' + (metrics.stillOnHand30Days||0).toLocaleString() + ' of $' + (metrics.received30Days||0).toLocaleString() + ' cost';
      setHealthClass('health30', metrics.pctOnHand30Days, 50, 70);
      document.getElementById('pct45').textContent = metrics.pctOnHand45Days + '%';
      document.getElementById('val45').textContent = '$' + (metrics.stillOnHand45Days||0).toLocaleString() + ' of $' + (metrics.received45Days||0).toLocaleString() + ' cost';
      setHealthClass('health45', metrics.pctOnHand45Days, 40, 60);
      document.getElementById('pct60').textContent = metrics.pctOnHand60Days + '%';
      document.getElementById('val60').textContent = '$' + (metrics.stillOnHand60Days||0).toLocaleString() + ' of $' + (metrics.received60Days||0).toLocaleString() + ' cost';
      setHealthClass('health60', metrics.pctOnHand60Days, 20, 40);
      document.getElementById('pct90').textContent = metrics.pctOnHand90Days + '%';
      document.getElementById('val90').textContent = '$' + (metrics.stillOnHand90Days||0).toLocaleString() + ' of $' + (metrics.received90Days||0).toLocaleString() + ' cost';
      setHealthClass('health90', metrics.pctOnHand90Days, 10, 25);
    }

    function setHealthClass(id, val, good, warn) {
      const el = document.getElementById(id);
      el.classList.remove('good','warning','danger');
      el.classList.add(val <= good ? 'good' : val <= warn ? 'warning' : 'danger');
    }

    function renderVelocity() {
      if (!inventoryData?.velocity) return;
      const catHtml = inventoryData.velocity.byCategory.slice(0,6).map((c,i) => {
        const speed = c.avgDaysToSell <= 30 ? 'fast' : c.avgDaysToSell >= 60 ? 'slow' : '';
        const rank = i < 2 ? 'fast' : i >= 4 ? 'slow' : '';
        return '<div class="velocity-item"><div class="velocity-rank '+rank+'">'+(i+1)+'</div><div class="velocity-info"><div class="velocity-name">'+c.name+'</div><div class="velocity-meta">'+c.itemsSold+' items sold</div></div><div class="velocity-days '+speed+'">'+c.avgDaysToSell+' days</div></div>';
      }).join('');
      document.getElementById('categoryVelocity').innerHTML = catHtml || '<p style="color:#888">Not enough data yet</p>';
      const venHtml = inventoryData.velocity.byVendor.slice(0,6).map((v,i) => {
        const speed = v.avgDaysToSell <= 30 ? 'fast' : v.avgDaysToSell >= 60 ? 'slow' : '';
        const rank = i < 2 ? 'fast' : i >= 4 ? 'slow' : '';
        return '<div class="velocity-item"><div class="velocity-rank '+rank+'">'+(i+1)+'</div><div class="velocity-info"><div class="velocity-name">'+v.name+'</div><div class="velocity-meta">'+v.itemsSold+' items sold</div></div><div class="velocity-days '+speed+'">'+v.avgDaysToSell+' days</div></div>';
      }).join('');
      document.getElementById('vendorVelocity').innerHTML = venHtml || '<p style="color:#888">Not enough data yet</p>';
    }

    function renderDeadStock() {
      if (!inventoryData?.deadStock) return;
      const s = inventoryData.deadStock.summary;
      document.getElementById('countWatch').textContent = s.itemsWatch || 0;
      document.getElementById('count60').textContent = s.items60Days || 0;
      document.getElementById('count90').textContent = s.items90Days || 0;
      document.getElementById('count120').textContent = s.items120Days || 0;
      document.getElementById('valueWatch').textContent = '$' + (s.valueWatch||0).toLocaleString() + ' at cost';
      document.getElementById('value60').textContent = '$' + (s.value60Days||0).toLocaleString() + ' at cost';
      document.getElementById('value90').textContent = '$' + (s.value90Days||0).toLocaleString() + ' at cost';
      document.getElementById('value120').textContent = '$' + (s.value120Days||0).toLocaleString() + ' at cost';
      renderTable();
    }

    function filterByBucket(bucket) {
      currentFilter = bucket;
      document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
      document.getElementById('filter' + (bucket === 'all' ? 'All' : bucket.charAt(0).toUpperCase() + bucket.slice(1))).classList.add('active');
      if (bucket !== 'all') document.getElementById('card' + bucket.charAt(0).toUpperCase() + bucket.slice(1)).classList.add('active');
      renderTable();
    }

    function renderTable() {
      if (!inventoryData?.deadStock?.items?.length) {
        document.getElementById('tableBody').innerHTML = '<div class="empty-state"><div class="icon">üéâ</div><h3>No aging inventory!</h3><p>All inventory is under 45 days old.</p></div>';
        return;
      }
      let items = inventoryData.deadStock.items;
      if (currentFilter !== 'all') items = items.filter(i => i.bucket === currentFilter);
      if (!items.length) {
        document.getElementById('tableBody').innerHTML = '<div class="empty-state"><div class="icon">üéâ</div><h3>No items in this bucket!</h3><p>Great news!</p></div>';
        return;
      }
      document.getElementById('tableBody').innerHTML = items.map(i => '<div class="table-row"><div><div class="item-name">'+i.name+'</div></div><div class="item-meta">'+i.vendor+'</div><div class="item-meta">'+(i.category||'-')+'</div><div>'+(i.qtyReceived||'-')+'</div><div>'+(i.qtySold||0)+'</div><div><strong>'+i.qtyRemaining+'</strong></div><div><span class="days-badge '+i.bucket+'">'+i.daysSinceReceived+'d</span></div><div class="suggested-action">'+(i.suggestedMarkdown||'-')+'</div></div>').join('');
    }

    async function runSync() {
      const btn = document.getElementById('syncBtn');
      const status = document.getElementById('syncStatus');
      btn.disabled = true;
      btn.textContent = '‚è≥ Syncing...';
      status.textContent = 'Analyzing inventory (1-2 minutes)...';
      status.classList.remove('success');
      try {
        const response = await fetch('/api/inventory/sync', { method: 'POST' });
        const result = await response.json();
        if (result.success) {
          status.textContent = 'Sync complete! (' + result.duration + ')';
          status.classList.add('success');
          await loadData();
        } else {
          status.textContent = 'Sync failed: ' + (result.error || 'Unknown error');
        }
      } catch (error) {
        status.textContent = 'Sync failed: ' + error.message;
      }
      btn.disabled = false;
      btn.textContent = 'üîÑ Sync Data';
    }

    loadData();
  </script>
</body>
</html>
